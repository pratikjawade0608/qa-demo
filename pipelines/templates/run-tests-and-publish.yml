parameters:
- name: 'JIRA_CLIENT_ID'
  type: string
- name: 'JIRA_CLIENT_SECRET'
  type: string
- name: 'XRAY_PROJECT_KEY'
  type: string
- name: 'ENVIRONMENT'
  type: string
- name: 'XRAY_SUMMARY'
  type: string

steps:
  - task: Cache@2
    inputs:
      key: '"funcs" | maven |"$(Agent.OS)" | **/pom.xml'
      restoreKeys: |
      path: $(MAVEN_CACHE_FOLDER)
    displayName: Cache Maven local repo

  - task: MavenAuthenticate@0
    displayName: "Maven Authenticate"
    inputs:
      artifactsFeeds: "$(mavenRepoName)"

  - task: Maven@3
    displayName: "Run E2E Tests"
    inputs:
      mavenPomFile: "$(workingDirectory)/pom.xml"
      goals: "clean install"
      javaHomeOption: "JDKVersion"
      mavenVersionOption: "Default"
      publishJUnitResults: false
      testResultsFiles: '**/*.json'
    continueOnError: true

  - bash: |
      for FILE in $(workingDirectory)target/cucumber-reports/*.json; do 
          echo $FILE 
          if jq empty $FILE ; then
            echo "JSON is valid"
          else
            echo "JSON is invalid"
          fi                        
      done        
    displayName: List report files found

  - bash: |
      echo "Authentication"
      token=$(curl -k -H "Content-Type: application/json" -X POST --data '{ "client_id": "${{ parameters.JIRA_CLIENT_ID }}","client_secret": "${{ parameters.JIRA_CLIENT_SECRET }}" }' https://xray.cloud.xpand-it.com/api/v1/authenticate| tr -d '"')
      echo "Combining report files"
      jq -s 'add' $(workingDirectory)target/cucumber-reports/*.json > runreport.json    
      echo "Creating metadata"        
      jq -n \
            --arg XRAY_PROJECT_KEY "${{ parameters.XRAY_PROJECT_KEY }}" \
            --arg ENVIRONMENT "${{ parameters.ENVIRONMENT }}" \
            --arg XRAY_SUMMARY "${{ parameters.XRAY_SUMMARY }}" \
            '{
                "fields": {
                  "project": {
                    "key": $XRAY_PROJECT_KEY
                  },
                  "summary": $XRAY_SUMMARY,
                  "issuetype": {
                    "id": "10061"
                  },
                  "customfield_10155" : [
                    $ENVIRONMENT
                  ]
                },"xrayFields": {        
                  "environments": [$ENVIRONMENT]
                  }
              }' > runmetadata.json
      cat runmetadata.json
      echo "Publishing results"
      echo $(curl -v -k -X POST -H "Authorization: Bearer ${token}" -F results=@runreport.json -F info=@runmetadata.json https://xray.cloud.xpand-it.com/api/v1/import/execution/cucumber/multipart)
      echo "Finished"
    displayName: Publishing results